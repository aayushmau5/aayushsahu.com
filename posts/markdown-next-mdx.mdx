---
title: "Using MDX with NextJS"
description: "How to use MDX with NextJS?"
date: 2022-01-20T07:27:46.681Z
tags: ["mdx", "nextjs", "markdown"]
cover:
	image: "/blogImages/"
	alt: ""
	caption: ""
draft: true
---

# Introduction

**MDX** is a markdown extension that brings in support for JS components(typically react components, but not only limited to) inside markdown.

Here's what I did to use MDX with NextJS.

To know more about MDX, checkout the official MDX docs [here](https://mdxjs.com/docs/getting-started/).

# Goal

My main goal was to:

- Get MDX working
- Integrate remark/rehype plugins for syntax highlighting, heading links, generating slugs, etc.
- Using custom react components inside my blogs
- Since all my posts are in a `posts/` directory, I want this directory to be the source(I don't like mixing up JS and MDX files).

# Using MDX with NextJS

The idea of using MDX in my blogs came from [this article](https://www.joshwcomeau.com/blog/how-i-built-my-blog/) by [Josh W Comeau](https://www.joshwcomeau.com/) (ðŸ™ thanks, Josh).

As it turns out, there are multiple libraries that allows us to use MDX with NextJS. Some of them are(based on popularity/usage):

- `@next/mdx`
- `mdx-bundler`
- `next-mdx-enhanced` (**deprecated**, maintainers now recommend `next-mdx-remote`)
- `next-mdx-remote`

I was pretty confused as to which library should I use. [This article](https://dev.to/tylerlwsmith/quick-comparison-of-mdx-integration-strategies-with-next-js-1kcm) compares these libraries pretty well.

> There's no "the best" solution out there. Just use the one you feel like going with, and if you face any problems in the way, try to fix it or switch to other solution.

With some struggles, I chose `next-mdx-remote`.

<HiddenExpand summary="My struggle with @next/mdx">

At first, I was not sure which library to go with. So, I started with `@next/mdx`, but things kinda started going wrong. See how ðŸ‘‡

**Trying `@next/mdx`**

I basically followed [this guide](https://nextjs.org/docs/advanced-features/using-mdx) to setup MDX. In order to use MDX with NextJS, we have to modify the NextJS config file `next.config.js`.

Install the `@next/mdx` library using

```
npm i @next/mdx
```

Then modify `next.config.js` as below.

```js
// next.config.js
const withMDX = require("@next/mdx")();
module.exports = withMDX();

// OR

const withMDX = require("@next/mdx")({
  extension: /\.(md|mdx)$/,
});

module.exports = withMDX({
  pageExtensions: ["js", "jsx", "md", "mdx", "ts", "tsx"],
});
```

After making the changes, I went ahead and made a `.mdx` file inside the `/pages` directory. And it worked!

**The problem**

I use `remark` plugins in order to have syntax highlighting, heading links, generating slugs, etc. And these remark plugins are ESM only(i.e. they use `import` instead of `require`), and I couldn't use `import` statements inside `next.config.js`.

I did manage to workaround this problem by having `"type": "module"` in `package.json` and rename `next.config.js` to `next.config.mjs`.

Now my `next.config.mjs` looks like this:

```js
import rehypeSlug from "rehype-slug";
import remarkToc from "remark-toc";
import NextMdx from "@next/mdx";

const withMDX = NextMdx({
  extension: /\.(md|mdx)$/,
  options: {
    remarkPlugins: [remarkToc],
    rehypePlugins: [rehypeSlug],
  },
});

export default withMDX({
  pageExtensions: ["md", "tsx"],
});
```

This didn't help because I started getting webpack warnings with remark plugins, and some plugins refused to work, and the internet didn't help ðŸ˜ž

![Remark plugin error](/blogImages/markdown-next-mdx/webpack-error.png)

And with that, my journey with `@next/mdx` ended.

</HiddenExpand>

# Using `next-mdx-remote`

I looked at [this example](https://github.com/vercel/next.js/tree/canary/examples/with-mdx-remote) to get a general idea of using `next-mdx-remote`. I recommend you check out that example as well.

## Directory Structure

```
posts/
â”œâ”€â”€ blog1.mdx
â””â”€â”€ blog2.mdx
pages/
â”œâ”€â”€ blog/
â”‚   â”œâ”€â”€ index.js
â”‚   â””â”€â”€ [slug].js
â””â”€â”€ index.js
utils/
â””â”€â”€ getPostData.js
```

Like I said, the `posts/` directory contains all my `mdx` blogs, and `utils/getPostData.js` contains some utility functions. We will see what those utility functions are, later.

As we already know, `pages/blog/index.js` points to `/blog` route & `pages/blog/[slug].js` is a dynamic route which will point to anything that comes after `/blog`, for example, `/blog/something`.

The point being, `/blog` route will have the index of all blogs, and the dynamic route will point to a specific blog(identified by the `slug`) which is a MDX blog.

## Steps

Install the following packages

```
npm i next-mdx-remote gray-matter
```

One thing to note about `next-mdx-remote` is that it doesn't care about where your data comes from, all it needs is that you provide the data. Like I said earlier, all my MDX blogs are inside a `posts/` directory, so we need to perform some kind of operation in order to provide `next-mdx-remote` my MDX blogs from `posts/` directory.

We will create some utility functions that will:

- get all the **sorted** posts data(like the contents, and frontmatter). This will be used in `/blog` route to index all the blogs.
- get all the post id.
- get post contents corresponding to their `slug`.

```js
// utils/getPostData.js
import fs from "fs";
import path from "path";
import matter from "gray-matter";

const postsDirectory = path.join(process.cwd(), "posts"); // the posts/ directory path
const fileNames = fs.readdirSync(postsDirectory); // all the mdx files inside the posts/ directory

// sorted post data
export function getSortedPostsData() {
  const allPostsData = fileNames
    .map((fileName) => {
      const slug = fileName.replace(/\.mdx$/, ""); // remove the .mdx extension from file names

      const fullPath = path.join(postsDirectory, fileName);
      const fileContents = fs.readFileSync(fullPath, "utf-8"); // read the file contents

      const { data: frontMatter } = matter(fileContents); // get the frontmatter

      return {
        slug,
        ...frontMatter,
      };
    });

  // sort the posts
  return allPostsData.sort((a, b) => {
    if (a.date < b.date) {
      return 1;
    } else {
      return -1;
    }
  });
}

// all post ids(or slug)
export function getAllPostIds() {
  const fileNames = fs.readdirSync(postsDirectory);
  return fileNames.map((fileName) => ({
    params: {
      slug: fileName.replace(/\.mdx$/, ""),
    },
  }));
}

// a particular post data
export async function getPostData(slug) {
  const fullPath = path.join(postsDirectory, `${slug}.mdx`); // get the full path of a post
  const fileContents = fs.readFileSync(fullPath, "utf-8"); // read the post contents

  const matterResult = matter(fileContents);

  return {
    slug,
    content: matterResult.content, // the file contents without the frontmatter
    frontmatter: matterResult.data, // the frontmatter
  };
}
```

```jsx
// /pages/blog/[slug].js
import { GetStaticProps, GetStaticPaths } from "next";

import { serialize } from "next-mdx-remote/serialize";
import { MDXRemote } from "next-mdx-remote";

import rehypePrism from "rehype-prism-plus";
import remarkToc from "remark-toc";
import rehypeSlug from "rehype-slug";
import rehypeAutolinkHeadings from "rehype-autolink-headings";

import { getAllPostIds, getPostData } from "@/utils/getPosts";
import BlogContainer from "@/components/BlogContainer";

const components = {};

export default function BlogPost({ source, frontmatter, slug }) {
  return (
    <>
      <BlogContainer frontmatter={frontmatter}>
        <MDXRemote {...source} components={components} />
      </BlogContainer>
    </>
  );
}

export const getStaticPaths: GetStaticPaths = async () => {
  const paths = getAllPostIds();
  return {
    paths,
    fallback: false,
  };
};

export const getStaticProps: GetStaticProps = async ({ params }) => {
  const { content, frontmatter, slug } = await getPostData(
    params.slug as string
  );
  const mdxSource = await serialize(content, {
    scope: frontmatter,
    mdxOptions: {
      rehypePlugins: [
        [rehypeAutolinkHeadings, { behavior: "append" }],
        [rehypePrism, { showLineNumbers: true }],
        rehypeSlug,
      ],
      remarkPlugins: [[remarkToc, { tight: true }]],
    },
  });
  return { props: { source: mdxSource, frontmatter, slug } };
};
```

## Concerns

- Bundle size & the solution with dynamic importing way
  Reading about `next-mdx-remote`, it turns out that all the components are bundled during build time and It is available to every MDX file.
  Though one can use dynamic importing and some clever hack to dynamically import heavy components.
  See more at: https://github.com/hasicorp/next-mdx-enhanced/issues/103
- HMR
  Use this to get realtime HMR thing: https://github.com/hashicorp/next-remote-watch
  https://nextjs.org/docs/advanced-features/preview-mode
  Preview mode doesn't work due to 2kb limit and much more work to setup.
- Per page bundle size

# `mdx-bundler`

ðŸ¤”
I never looked into `mdx-bundler` but it seemed to have all the goodies to use MDX. And it is framework agnostic, so you can use it with anything else.
